<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spotify to Qobuz Migration</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <style>[x-cloak] { display: none !important; }</style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen">
    <nav class="bg-gray-800 border-b border-gray-700">
        <div class="max-w-6xl mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <a href="/" class="text-xl font-bold text-white hover:text-blue-400">Spotify -> Qobuz</a>
                <div class="flex gap-4">
                    <a href="/" class="text-gray-300 hover:text-white">Home</a>
                    <a href="/playlists" class="text-gray-300 hover:text-white">Playlists</a>
                    <a href="/compare" class="text-gray-300 hover:text-white">Compare</a>
                    <a href="/history" class="text-gray-300 hover:text-white">History</a>
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-6xl mx-auto px-4 py-8">
        <div class="space-y-6" x-data="syncApp()" x-init="init()">
            <!-- Connection Status -->
            <div class="flex items-center justify-between bg-gray-800 rounded-lg p-4 border border-gray-700">
                <div class="flex items-center gap-6">
                    <div class="flex items-center gap-2">
                        <div class="w-3 h-3 rounded-full <%= auth_status.spotify ? 'bg-green-500' : 'bg-gray-500' %>"></div>
                        <span class="text-sm">Spotify</span>
                        <% if (auth_status.spotify) { %><span class="text-xs text-gray-400" x-text="spotifyStats.playlists + ' playlists'"></span><% } %>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-3 h-3 rounded-full <%= auth_status.qobuz ? 'bg-green-500' : 'bg-gray-500' %>"></div>
                        <span class="text-sm">Qobuz</span>
                        <% if (auth_status.qobuz) { %><span class="text-xs text-gray-400" x-text="qobuzStats.playlists + ' playlists'"></span><% } %>
                    </div>
                </div>
                <div class="flex gap-2">
                    <% if (!auth_status.spotify) { %><a href="/auth/spotify" class="px-3 py-1 bg-green-600 hover:bg-green-500 rounded text-sm">Connect Spotify</a><% } %>
                    <% if (!auth_status.qobuz) { %><a href="/auth/qobuz" class="px-3 py-1 bg-blue-600 hover:bg-blue-500 rounded text-sm">Connect Qobuz</a><% } %>
                </div>
            </div>

            <% if (auth_status.both_connected) { %>
            <!-- Sync Progress -->
            <div x-show="syncing" x-cloak class="bg-gradient-to-r from-green-900/30 to-blue-900/30 rounded-lg p-6 border border-blue-500">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 border-2 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
                        <div>
                            <h2 class="font-semibold" x-text="syncType === 'favorites' ? 'Syncing Saved Tracks' : (syncType === 'albums' ? 'Syncing Albums' : 'Syncing Playlists')"></h2>
                            <p class="text-sm text-gray-400" x-text="progress.current_playlist || 'Starting...'"></p>
                        </div>
                    </div>
                    <div class="text-2xl font-bold" x-text="(progress.percent_complete || 0).toFixed(0) + '%'"></div>
                </div>
                <div class="w-full bg-gray-700 rounded-full h-3 mb-4">
                    <div class="bg-gradient-to-r from-green-500 to-blue-500 h-3 rounded-full transition-all" :style="'width:' + (progress.percent_complete || 0) + '%'"></div>
                </div>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                    <div class="bg-gray-800/50 rounded-lg p-3">
                        <div class="text-2xl font-bold text-green-400" x-text="progress.tracks_matched || 0"></div>
                        <div class="text-xs text-gray-400">Matched</div>
                    </div>
                    <div class="bg-gray-800/50 rounded-lg p-3">
                        <div class="text-2xl font-bold text-yellow-400" x-text="progress.tracks_not_matched || 0"></div>
                        <div class="text-xs text-gray-400">Not Found</div>
                    </div>
                    <div class="bg-gray-800/50 rounded-lg p-3">
                        <div class="text-2xl font-bold text-blue-400" x-text="progress.isrc_matches || 0"></div>
                        <div class="text-xs text-gray-400">ISRC/UPC</div>
                    </div>
                    <div class="bg-gray-800/50 rounded-lg p-3">
                        <div class="text-2xl font-bold text-purple-400" x-text="progress.fuzzy_matches || 0"></div>
                        <div class="text-xs text-gray-400">Fuzzy</div>
                    </div>
                </div>
            </div>

            <!-- Completion -->
            <div x-show="completed && !syncing" x-cloak class="bg-gradient-to-r from-green-900/30 to-blue-900/30 rounded-lg p-6 border border-green-500">
                <div class="flex items-center gap-3 mb-4">
                    <div class="w-10 h-10 bg-green-500 rounded-full flex items-center justify-center">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                    </div>
                    <h2 class="font-semibold text-lg">Sync Complete!</h2>
                </div>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="bg-gray-800/50 rounded-lg p-4 text-center">
                        <div class="text-3xl font-bold text-green-400" x-text="progress.tracks_matched || 0"></div>
                        <div class="text-sm text-gray-400">Matched</div>
                    </div>
                    <div class="bg-gray-800/50 rounded-lg p-4 text-center">
                        <div class="text-3xl font-bold text-yellow-400" x-text="progress.tracks_not_matched || 0"></div>
                        <div class="text-sm text-gray-400">Not Found</div>
                    </div>
                    <div class="bg-gray-800/50 rounded-lg p-4 text-center">
                        <div class="text-3xl font-bold text-blue-400" x-text="progress.isrc_matches || 0"></div>
                        <div class="text-sm text-gray-400">ISRC/UPC</div>
                    </div>
                    <div class="bg-gray-800/50 rounded-lg p-4 text-center">
                        <div class="text-3xl font-bold text-purple-400" x-text="progress.fuzzy_matches || 0"></div>
                        <div class="text-sm text-gray-400">Fuzzy</div>
                    </div>
                </div>
                <div x-show="(progress.tracks_not_matched || 0) > 0" class="mt-4">
                    <a href="/review" class="block w-full text-center px-4 py-3 bg-yellow-600 hover:bg-yellow-500 rounded-lg font-medium">
                        Review <span x-text="progress.tracks_not_matched"></span> Unmatched
                    </a>
                </div>
            </div>

            <!-- Quick Actions -->
            <div x-show="!syncing && !completed" class="space-y-4">
                <div class="flex items-center justify-end gap-3 px-2">
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" x-model="dryRun" class="w-4 h-4 rounded bg-gray-700 border-gray-600 text-blue-500">
                        <span class="text-sm text-gray-400">Dry Run</span>
                    </label>
                </div>
                <div class="grid md:grid-cols-3 gap-4">
                    <button @click="startSync('playlists')" class="p-6 bg-gray-800 hover:bg-gray-750 rounded-lg border border-gray-700 hover:border-green-500 text-left group">
                        <h3 class="text-lg font-semibold group-hover:text-green-400">Sync Playlists</h3>
                        <p class="text-sm text-gray-400">Transfer <span x-text="spotifyStats.playlists"></span> playlists</p>
                    </button>
                    <button @click="startSync('favorites')" class="p-6 bg-gray-800 hover:bg-gray-750 rounded-lg border border-gray-700 hover:border-blue-500 text-left group">
                        <h3 class="text-lg font-semibold group-hover:text-blue-400">Sync Saved Tracks</h3>
                        <p class="text-sm text-gray-400">Transfer <span x-text="spotifyStats.savedTracks"></span> tracks</p>
                    </button>
                    <button @click="startSync('albums')" class="p-6 bg-gray-800 hover:bg-gray-750 rounded-lg border border-gray-700 hover:border-purple-500 text-left group">
                        <h3 class="text-lg font-semibold group-hover:text-purple-400">Sync Saved Albums</h3>
                        <p class="text-sm text-gray-400">Transfer <span x-text="spotifyStats.savedAlbums"></span> albums</p>
                    </button>
                </div>
            </div>

            <!-- Library Stats -->
            <div class="grid md:grid-cols-2 gap-6">
                <div class="bg-gray-800 rounded-lg border border-gray-700">
                    <div class="bg-green-600/10 border-b border-gray-700 px-4 py-3">
                        <h3 class="font-semibold">Spotify Library</h3>
                    </div>
                    <div class="p-4 space-y-3">
                        <div class="flex justify-between"><span class="text-gray-400">Playlists</span><span x-text="spotifyStats.playlists"></span></div>
                        <div class="flex justify-between"><span class="text-gray-400">Saved Tracks</span><span x-text="spotifyStats.savedTracks"></span></div>
                        <div class="flex justify-between"><span class="text-gray-400">Saved Albums</span><span x-text="spotifyStats.savedAlbums"></span></div>
                    </div>
                </div>
                <div class="bg-gray-800 rounded-lg border border-gray-700">
                    <div class="bg-blue-600/10 border-b border-gray-700 px-4 py-3">
                        <h3 class="font-semibold">Qobuz Library</h3>
                    </div>
                    <div class="p-4 space-y-3">
                        <div class="flex justify-between"><span class="text-gray-400">Playlists</span><span x-text="qobuzStats.playlists"></span></div>
                        <div class="flex justify-between"><span class="text-gray-400">From Spotify</span><span class="text-green-400" x-text="qobuzStats.fromSpotify"></span></div>
                        <div class="flex justify-between"><span class="text-gray-400">Favorites</span><span x-text="qobuzStats.favorites"></span></div>
                        <div class="flex justify-between"><span class="text-gray-400">Albums</span><span x-text="qobuzStats.favoriteAlbums"></span></div>
                    </div>
                </div>
            </div>
            <% } else { %>
            <!-- Not Connected -->
            <div class="bg-gray-800 rounded-lg p-8 text-center border border-gray-700">
                <div class="text-6xl mb-4">&#127925;</div>
                <h2 class="text-2xl font-bold mb-2">Connect Your Accounts</h2>
                <p class="text-gray-400 mb-6">Link Spotify and Qobuz to start migrating</p>
                <div class="flex justify-center gap-4">
                    <% if (!auth_status.spotify) { %><a href="/auth/spotify" class="px-6 py-3 bg-green-600 hover:bg-green-500 rounded-lg font-semibold">Connect Spotify</a><% } %>
                    <% if (!auth_status.qobuz) { %><a href="/auth/qobuz" class="px-6 py-3 bg-blue-600 hover:bg-blue-500 rounded-lg font-semibold">Connect Qobuz</a><% } %>
                </div>
            </div>
            <% } %>

            <% if (migrations && migrations.length > 0) { %>
            <!-- Recent Migrations -->
            <div class="bg-gray-800 rounded-lg border border-gray-700">
                <div class="border-b border-gray-700 px-4 py-3 flex items-center justify-between">
                    <h3 class="font-semibold">Recent Migrations</h3>
                    <a href="/history" class="text-sm text-blue-400 hover:underline">View all</a>
                </div>
                <div class="divide-y divide-gray-700">
                    <% migrations.slice(0, 5).forEach(m => { %>
                    <div class="px-4 py-3 flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <span class="px-2 py-1 rounded text-xs uppercase <%= m.status === 'completed' ? 'bg-green-600/20 text-green-400' : m.status === 'running' ? 'bg-blue-600/20 text-blue-400' : 'bg-red-600/20 text-red-400' %>"><%= m.status %></span>
                            <span class="text-sm"><%= m.migration_type %></span>
                            <% if (m.dry_run) { %><span class="px-1.5 py-0.5 rounded text-xs bg-yellow-600/20 text-yellow-400">DRY RUN</span><% } %>
                        </div>
                        <div class="flex items-center gap-4 text-sm">
                            <span class="text-green-400"><%= m.tracks_matched %> matched</span>
                            <% if (m.tracks_not_matched > 0) { %><span class="text-yellow-400"><%= m.tracks_not_matched %> missing</span><% } %>
                        </div>
                    </div>
                    <% }); %>
                </div>
            </div>
            <% } %>
        </div>
    </main>

    <script>
    function syncApp() {
        return {
            syncing: false, completed: false, syncType: '', taskId: null, progress: {}, dryRun: false,
            spotifyStats: { playlists: '...', savedTracks: '...', savedAlbums: '...' },
            qobuzStats: { playlists: '...', fromSpotify: '...', favorites: '...', favoriteAlbums: '...' },
            async init() { await this.refreshSpotify(); await this.refreshQobuz(); await this.checkActiveSync(); },
            async checkActiveSync() {
                try {
                    const res = await fetch('/sync/active');
                    const data = await res.json();
                    if (data.task_id) { this.syncing = true; this.taskId = data.task_id; this.syncType = data.sync_type || 'favorites'; this.progress = data.progress || {}; this.pollProgress(); }
                } catch (e) { console.error(e); }
            },
            async refreshSpotify() { try { const res = await fetch('/api/spotify/stats'); if (res.ok) this.spotifyStats = await res.json(); } catch (e) { console.error(e); } },
            async refreshQobuz() { try { const res = await fetch('/api/qobuz/stats'); if (res.ok) this.qobuzStats = await res.json(); } catch (e) { console.error(e); } },
            async startSync(type) {
                this.syncing = true; this.completed = false; this.syncType = type; this.progress = {};
                const formData = new FormData(); formData.append('type', type); if (this.dryRun) formData.append('dry_run', 'true');
                const res = await fetch('/sync/start', { method: 'POST', body: formData });
                const data = await res.json(); this.taskId = data.task_id; this.pollProgress();
            },
            async pollProgress() {
                if (!this.taskId) return;
                const poll = async () => {
                    try {
                        const res = await fetch('/sync/status/' + this.taskId);
                        const data = await res.json(); this.progress = data.progress || {};
                        if (data.status === 'completed') { this.syncing = false; this.completed = true; await this.refreshQobuz(); }
                        else if (data.status === 'failed') { this.syncing = false; alert('Sync failed: ' + (data.error || 'Unknown')); }
                        else { setTimeout(poll, 500); }
                    } catch (e) { console.error(e); setTimeout(poll, 1000); }
                }; poll();
            }
        };
    }
    </script>
</body>
</html>
