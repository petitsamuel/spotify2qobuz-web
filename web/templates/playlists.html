{% extends "base.html" %}

{% block title %}Select Playlists{% endblock %}

{% block content %}
<div class="space-y-6" x-data="{
    selected: [],
    syncing: false,
    taskId: null,
    progress: {},
    selectAll() {
        if (this.selected.length === {{ playlists | length }}) {
            this.selected = [];
        } else {
            this.selected = [{% for p in playlists %}'{{ p.id }}'{% if not loop.last %}, {% endif %}{% endfor %}];
        }
    }
}">
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-3xl font-bold">Your Playlists</h1>
            <p class="text-gray-400 mt-1">Select playlists to sync to Qobuz</p>
        </div>
        <div class="flex items-center gap-4">
            <span class="text-gray-400" x-text="selected.length + ' selected'"></span>
            <button
                @click="selectAll()"
                class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg transition text-sm"
            >
                <span x-show="selected.length !== {{ playlists | length }}">Select All</span>
                <span x-show="selected.length === {{ playlists | length }}" x-cloak>Deselect All</span>
            </button>
        </div>
    </div>

    <!-- Playlists Grid -->
    <div class="grid gap-3">
        {% for playlist in playlists %}
        <label
            class="flex items-center gap-4 p-4 bg-gray-800 rounded-lg border border-gray-700 cursor-pointer hover:bg-gray-750 transition"
            :class="{ 'ring-2 ring-blue-500 border-blue-500': selected.includes('{{ playlist.id }}') }"
        >
            <input
                type="checkbox"
                value="{{ playlist.id }}"
                x-model="selected"
                class="w-5 h-5 rounded bg-gray-700 border-gray-600 text-blue-600 focus:ring-blue-500"
            />
            <div class="flex-1 min-w-0">
                <div class="font-medium truncate">{{ playlist.name }}</div>
                <div class="text-sm text-gray-400">{{ playlist.tracks_count }} tracks</div>
            </div>
        </label>
        {% endfor %}
    </div>

    {% if playlists | length == 0 %}
    <div class="bg-gray-800 rounded-lg p-8 text-center">
        <p class="text-gray-400">No playlists found in your Spotify account.</p>
    </div>
    {% endif %}

    <!-- Sync Button -->
    {% if auth_status.both_connected %}
    <div class="sticky bottom-4 bg-gray-900/95 backdrop-blur rounded-lg p-4 border border-gray-700">
        <div x-show="!syncing" class="flex items-center gap-4">
            <button
                @click="
                    if (selected.length === 0) return;
                    syncing = true;
                    const formData = new FormData();
                    formData.append('type', 'playlists');
                    selected.forEach(id => formData.append('playlist_ids', id));
                    fetch('/sync/start', { method: 'POST', body: formData })
                        .then(r => r.json())
                        .then(data => { taskId = data.task_id; })
                "
                :disabled="selected.length === 0"
                class="flex-1 py-3 px-6 bg-gradient-to-r from-green-600 to-blue-600 hover:from-green-500 hover:to-blue-500 rounded-lg font-semibold transition disabled:opacity-50 disabled:cursor-not-allowed"
            >
                Sync Selected Playlists
            </button>
            <label class="flex items-center gap-2 text-sm text-gray-400">
                <input type="checkbox" id="dry-run" class="rounded bg-gray-700 border-gray-600">
                Dry run (preview only)
            </label>
        </div>

        <!-- Progress -->
        <div x-show="syncing" x-cloak
             x-init="$watch('taskId', (id) => {
                if (id) {
                    const poll = setInterval(async () => {
                        const res = await fetch('/sync/status/' + id);
                        const data = await res.json();
                        progress = data.progress || {};
                        if (data.status === 'completed' || data.status === 'failed') {
                            clearInterval(poll);
                            if (data.status === 'completed') {
                                setTimeout(() => window.location.href = '/', 1500);
                            }
                        }
                    }, 1000);
                }
             })">
            <div class="space-y-3">
                <div class="flex justify-between text-sm">
                    <span class="text-gray-400" x-text="progress.current_playlist || 'Starting...'"></span>
                    <span class="text-gray-400">
                        Playlist <span x-text="progress.current_playlist_index || 0"></span> of <span x-text="progress.total_playlists || selected.length"></span>
                    </span>
                </div>
                <div class="w-full bg-gray-700 rounded-full h-3">
                    <div class="bg-gradient-to-r from-green-500 to-blue-500 h-3 rounded-full transition-all duration-300"
                         :style="'width: ' + (progress.percent_complete || 0) + '%'"></div>
                </div>
                <div class="flex justify-between text-sm">
                    <span class="text-green-400" x-text="(progress.tracks_matched || 0) + ' matched'"></span>
                    <span class="text-yellow-400" x-text="(progress.tracks_not_matched || 0) + ' not found'"></span>
                    <span class="text-blue-400" x-text="(progress.isrc_matches || 0) + ' ISRC / ' + (progress.fuzzy_matches || 0) + ' fuzzy'"></span>
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <div class="sticky bottom-4 bg-yellow-600/20 border border-yellow-600/50 rounded-lg p-4 text-center">
        <p class="text-yellow-400">Connect both Spotify and Qobuz to sync playlists.</p>
        <a href="/" class="text-blue-400 hover:underline text-sm">Go to home page</a>
    </div>
    {% endif %}
</div>
{% endblock %}
