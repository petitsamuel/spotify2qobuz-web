{% extends "base.html" %}

{% block title %}Review Unmatched Tracks{% endblock %}

{% block content %}
<div class="space-y-6" x-data="reviewApp()" x-init="init()">

    <!-- Header -->
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-2xl font-bold">Review Unmatched Tracks</h1>
            <p class="text-gray-400 mt-1">Manually match tracks that couldn't be found automatically</p>
        </div>
        <a href="/" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg text-sm">Back to Home</a>
    </div>

    <!-- Filter Tabs -->
    <div class="flex items-center gap-4 border-b border-gray-700 pb-4">
        <button @click="filterType = null; loadTracks()"
                :class="filterType === null ? 'bg-blue-600 text-white' : 'bg-gray-700 hover:bg-gray-600 text-gray-300'"
                class="px-4 py-2 rounded-lg text-sm transition">
            All (<span x-text="totalCount"></span>)
        </button>
        <button @click="filterType = 'favorites'; loadTracks()"
                :class="filterType === 'favorites' ? 'bg-blue-600 text-white' : 'bg-gray-700 hover:bg-gray-600 text-gray-300'"
                class="px-4 py-2 rounded-lg text-sm transition">
            Tracks (<span x-text="favoritesCount"></span>)
        </button>
        <button @click="filterType = 'albums'; loadTracks()"
                :class="filterType === 'albums' ? 'bg-purple-600 text-white' : 'bg-gray-700 hover:bg-gray-600 text-gray-300'"
                class="px-4 py-2 rounded-lg text-sm transition">
            Albums (<span x-text="albumsCount"></span>)
        </button>

        <div class="flex-1"></div>

        <!-- Status filter -->
        <select x-model="filterStatus" @change="loadTracks()"
                class="bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-sm">
            <option value="pending">Pending</option>
            <option value="resolved">Resolved</option>
            <option value="dismissed">Dismissed</option>
            <option value="">All Status</option>
        </select>
    </div>

    <!-- Loading State -->
    <div x-show="loading" class="flex items-center justify-center py-12">
        <div class="w-8 h-8 border-2 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
        <span class="ml-3 text-gray-400">Loading...</span>
    </div>

    <!-- Empty State -->
    <div x-show="!loading && tracks.length === 0" class="text-center py-12">
        <div class="text-6xl mb-4">✅</div>
        <h2 class="text-xl font-semibold mb-2">No unmatched tracks</h2>
        <p class="text-gray-400">All tracks have been matched or reviewed!</p>
    </div>

    <!-- Track List -->
    <div x-show="!loading && tracks.length > 0" class="space-y-4">
        <template x-for="track in tracks" :key="track.id">
            <div class="bg-gray-800 rounded-lg border border-gray-700 overflow-hidden"
                 :class="track.status === 'resolved' ? 'border-green-600/30' : track.status === 'dismissed' ? 'border-gray-600/30 opacity-60' : ''">

                <!-- Track Header -->
                <div class="p-4 flex items-center justify-between">
                    <div class="flex-1">
                        <div class="flex items-center gap-2">
                            <span class="text-white font-medium text-lg" x-text="track.title"></span>
                            <span class="px-2 py-0.5 rounded text-xs"
                                  :class="track.sync_type === 'albums' ? 'bg-purple-600/20 text-purple-400' : 'bg-blue-600/20 text-blue-400'"
                                  x-text="track.sync_type === 'albums' ? 'Album' : 'Track'"></span>
                            <span x-show="track.status !== 'pending'"
                                  class="px-2 py-0.5 rounded text-xs"
                                  :class="track.status === 'resolved' ? 'bg-green-600/20 text-green-400' : 'bg-gray-600/20 text-gray-400'"
                                  x-text="track.status"></span>
                        </div>
                        <div class="text-gray-400 mt-1">
                            <span x-text="track.artist"></span>
                            <span x-show="track.album" class="text-gray-500"> • <span x-text="track.album"></span></span>
                        </div>
                    </div>

                    <!-- Actions for pending tracks -->
                    <div x-show="track.status === 'pending'" class="flex items-center gap-2">
                        <button @click="dismissTrack(track)"
                                class="px-3 py-1.5 bg-gray-700 hover:bg-gray-600 rounded text-sm text-gray-300">
                            Skip
                        </button>
                    </div>
                </div>

                <!-- Suggestions -->
                <div x-show="track.suggestions && track.suggestions.length > 0 && track.status === 'pending'"
                     class="border-t border-gray-700 p-4 bg-gray-800/50">
                    <div class="text-sm text-gray-400 mb-3">Possible matches:</div>
                    <div class="space-y-2">
                        <template x-for="(sug, idx) in track.suggestions" :key="sug.qobuz_id">
                            <div class="flex items-center justify-between bg-gray-700/30 rounded-lg p-3">
                                <div class="flex-1">
                                    <span class="text-white" x-text="sug.title"></span>
                                    <span class="text-gray-400"> by </span>
                                    <span class="text-gray-300" x-text="sug.artist"></span>
                                    <span x-show="sug.album" class="text-gray-500 text-sm ml-2" x-text="'(' + sug.album + ')'"></span>
                                    <div class="flex items-center gap-2 mt-1">
                                        <span class="px-1.5 py-0.5 rounded text-xs"
                                              :class="(sug.title_score || sug.score) >= 80 ? 'bg-green-600/30 text-green-400' : (sug.title_score || sug.score) >= 60 ? 'bg-yellow-600/30 text-yellow-400' : 'bg-gray-600/30 text-gray-400'"
                                              x-text="'Title: ' + (sug.title_score || sug.score) + '%'"></span>
                                        <span class="px-1.5 py-0.5 rounded text-xs"
                                              :class="(sug.artist_score || sug.score) >= 80 ? 'bg-green-600/30 text-green-400' : (sug.artist_score || sug.score) >= 60 ? 'bg-yellow-600/30 text-yellow-400' : 'bg-gray-600/30 text-gray-400'"
                                              x-text="'Artist: ' + (sug.artist_score || sug.score) + '%'"></span>
                                    </div>
                                </div>
                                <button @click="resolveTrack(track, sug)"
                                        class="ml-4 px-4 py-2 bg-green-600 hover:bg-green-500 rounded text-sm text-white whitespace-nowrap">
                                    Add to Qobuz
                                </button>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- No suggestions -->
                <div x-show="(!track.suggestions || track.suggestions.length === 0) && track.status === 'pending'"
                     class="border-t border-gray-700 p-4 bg-gray-800/50">
                    <div class="text-sm text-gray-500">No suggestions available - this track may not exist on Qobuz</div>
                </div>
            </div>
        </template>

        <!-- Pagination -->
        <div x-show="total > limit" class="flex items-center justify-between pt-4">
            <div class="text-sm text-gray-400">
                Showing <span x-text="offset + 1"></span>-<span x-text="Math.min(offset + limit, total)"></span> of <span x-text="total"></span>
            </div>
            <div class="flex items-center gap-2">
                <button @click="prevPage()" :disabled="offset === 0"
                        :class="offset === 0 ? 'opacity-50 cursor-not-allowed' : 'hover:bg-gray-600'"
                        class="px-3 py-1.5 bg-gray-700 rounded text-sm">
                    Previous
                </button>
                <button @click="nextPage()" :disabled="offset + limit >= total"
                        :class="offset + limit >= total ? 'opacity-50 cursor-not-allowed' : 'hover:bg-gray-600'"
                        class="px-3 py-1.5 bg-gray-700 rounded text-sm">
                    Next
                </button>
            </div>
        </div>
    </div>
</div>

<script>
function reviewApp() {
    return {
        tracks: [],
        loading: true,
        filterType: null,
        filterStatus: 'pending',
        total: 0,
        limit: 50,
        offset: 0,
        favoritesCount: {{ favorites_count }},
        albumsCount: {{ albums_count }},

        get totalCount() {
            return this.favoritesCount + this.albumsCount;
        },

        async init() {
            await this.loadTracks();
        },

        async loadTracks() {
            this.loading = true;
            this.offset = 0;

            try {
                let url = `/api/unmatched?limit=${this.limit}&offset=${this.offset}`;
                if (this.filterType) url += `&sync_type=${this.filterType}`;
                if (this.filterStatus) url += `&status=${this.filterStatus}`;

                const res = await fetch(url);
                const data = await res.json();

                this.tracks = data.tracks;
                this.total = data.total;
            } catch (e) {
                console.error('Failed to load tracks:', e);
            } finally {
                this.loading = false;
            }
        },

        async resolveTrack(track, suggestion) {
            try {
                const formData = new FormData();
                formData.append('qobuz_id', suggestion.qobuz_id);
                formData.append('sync_type', track.sync_type);

                const res = await fetch(`/api/unmatched/${track.spotify_id}/resolve`, {
                    method: 'POST',
                    body: formData
                });

                if (res.ok) {
                    track.status = 'resolved';
                    this.updateCounts();
                } else {
                    const error = await res.json();
                    alert('Failed to resolve: ' + (error.detail || 'Unknown error'));
                }
            } catch (e) {
                console.error('Failed to resolve track:', e);
                alert('Failed to resolve track: ' + e.message);
            }
        },

        async dismissTrack(track) {
            try {
                const formData = new FormData();
                formData.append('sync_type', track.sync_type);

                const res = await fetch(`/api/unmatched/${track.spotify_id}/dismiss`, {
                    method: 'POST',
                    body: formData
                });

                if (res.ok) {
                    track.status = 'dismissed';
                    this.updateCounts();
                }
            } catch (e) {
                console.error('Failed to dismiss track:', e);
            }
        },

        updateCounts() {
            // Decrement the appropriate counter
            if (this.filterStatus === 'pending') {
                if (this.filterType === 'favorites') {
                    this.favoritesCount = Math.max(0, this.favoritesCount - 1);
                } else if (this.filterType === 'albums') {
                    this.albumsCount = Math.max(0, this.albumsCount - 1);
                } else {
                    // Reload to get accurate counts
                    this.loadTracks();
                }
            }
        },

        prevPage() {
            if (this.offset > 0) {
                this.offset = Math.max(0, this.offset - this.limit);
                this.loadTracks();
            }
        },

        nextPage() {
            if (this.offset + this.limit < this.total) {
                this.offset += this.limit;
                this.loadTracks();
            }
        }
    };
}
</script>
{% endblock %}
